@page "/incomes"
@using Xpense.Utility
@inject ServiceClient ServiceClient
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject IFormatter Formatter
@inject ISettingsManager SettingsManager
@inject DateFilter Filter

@if (_loading)
{
    <Loading />
}
else
{
    <RadzenCard>
        <RadzenRow Gap="1rem">
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.H6"><strong>Count</strong></RadzenText>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.H6" Text="@_incomes.Count().ToString()"></RadzenText>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow Gap="1rem">
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.H6"><strong>Total</strong></RadzenText>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.H6" Text="@Formatter.FormatAsEuro(_incomes.Sum(e => e.IncomeDetails.Value))"></RadzenText>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
    <RadzenCard>
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="3">
                <RadzenText Text="From"></RadzenText>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenDatePicker @bind-Value=@Filter.From DateFormat="yyyy-MM-dd" Class="w-100" Change="@GetIncomesAsync" />
            </RadzenColumn>
        </RadzenRow>
        <br />
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="3">
                <RadzenText Text="To"></RadzenText>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenDatePicker @bind-Value=@Filter.To DateFormat="yyyy-MM-dd" Class="w-100" Change="@GetIncomesAsync" />
            </RadzenColumn>
        </RadzenRow>
        <br />
        <RadzenRow Gap="1rem" class="rz-text-align-center">
            <RadzenColumn>
                <RadzenButton Click=@ResetFilterAsync ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Button" Text="Reset to current month"></RadzenButton>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
    <RadzenCard class="rz-text-align-center">
        <RadzenButton Click=@CreateNewIncome ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Button" Icon="add" Text="Add new" Size="ButtonSize.Large"></RadzenButton>
    </RadzenCard>
    <RadzenCard>
        <RadzenDataGrid RowClick="@RowClick" Data="@_incomes" TItem="Xpense.Income" GridLines="DataGridGridLines.Default" AllowPaging="true" AllowSorting="false">
            <Columns>
                <RadzenDataGridColumn TItem="Xpense.Income" Property="IncomeDetails.Date" Title="Date">
                    <Template Context="detail">
                        @detail.IncomeDetails.Date.ToString("yyyy-MM-dd")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Xpense.Income" Property="IncomeDetails.Value" Title="Value">
                    <Template Context="detail">
                        @Formatter.FormatAsEuro(detail.IncomeDetails.Value)
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>
    <br />
}

@code {
    private bool _loading = true;
    private IEnumerable<Xpense.Income> _incomes = Array.Empty<Xpense.Income>();

    protected override async Task OnInitializedAsync()
    {
        var username = SettingsManager.GetUsername();
        if (string.IsNullOrWhiteSpace(username))
        {
            await DialogService.Alert("No username has been configured, you will be redirected to the Settings page", "Username required", new AlertOptions
                {
                    ShowClose = false,
                    OkButtonText = "Ok"
                });
            NavigationManager.NavigateTo("/settings");
        }
        else
        {
            await GetIncomesAsync();
        }
    }

    private async Task ResetFilterAsync()
    {
        var now = DateTimeOffset.Now;
        var firstDayOfCurrentMonth = new DateTime(now.Year, now.Month, 1);
        var firstDayOfNextMonth = firstDayOfCurrentMonth.AddMonths(1);
        Filter.From = firstDayOfCurrentMonth;
        Filter.To = firstDayOfNextMonth;
        await GetIncomesAsync();
    }

    private async Task GetIncomesAsync()
    {
        try
        {
            _loading = true;
            _incomes = (await ServiceClient.GetAllIncomesAsync(Filter.From.ToString("yyyy-MM-dd"), Filter.To.ToString("yyyy-MM-dd"), null))
                .OrderByDescending(e => e.IncomeDetails.Date);
        }
        catch (Exception e)
        {
            await DialogService.Alert($"Cannot retrieve incomes. Error: {e.Message}", "Error", new AlertOptions
                {
                    ShowClose = false,
                    OkButtonText = "Ok"
                });
        }
        finally
        {
            _loading = false;
        }
    }

    private void GoToIncome(Guid? id)
    {
        NavigationManager.NavigateTo($"income/{id}");
    }

    private void CreateNewIncome()
    {
        NavigationManager.NavigateTo("new-income");
    }

    private void RowClick(DataGridRowMouseEventArgs<Xpense.Income> obj)
    {
        GoToIncome(obj.Data.Id);
    }

}
