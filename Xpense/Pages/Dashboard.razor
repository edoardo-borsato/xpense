@page "/dashboard"
@using Xpense.Utility
@inject ExpensesManager ExpensesManager
@inject IDialogService DialogService
@inject IFormatter Formatter

@if (_expenses == null)
{
    <Loading/>
}
else
{
    <RadzenCard>
        <div class="row">
            <div class="col h4 font-weight-bold">
                Count
            </div>
            <div class="col h4">
                @_expenses.Count()
            </div>
        </div>
        <div class="row">
            <div class="col h4 font-weight-bold">
                Total
            </div>
            <div class="col h4">
                @Formatter.FormatAsEuro(_expenses.Sum(e => e.ExpenseDetails.Value))
            </div>
        </div>
        <div class="row">
            <div class="col h4 font-weight-bold">
                AVG per month
            </div>
            <div class="col h4">
                @Formatter.FormatAsEuro(_averageExpensePerMonth)
            </div>
        </div>
    </RadzenCard>
    <RadzenCard>
        <div class="row">
            <div class="col h4">
                <RadzenDropDown AllowClear="false" TValue="int" Class="w-100" Data="@_availableYears" Change="@(OnYearChange)" Value="@_selectedYear" />
            </div>
            <div class="col h4">
                <RadzenDropDown AllowClear="false" TValue="string" Class="w-100" Data="@_availableMonths" Change="@(OnMonthChange)" Value="@_selectedMonth" />
            </div>
        </div>
    </RadzenCard>
    
@*BAR*@
    <RadzenCard>
        <RadzenChart Visible="@(_selectedMonth is not Month.AllMonths)">
            <RadzenPieSeries Data="@_selectedMonthDataGroupedByCategory" Title="@_selectedMonth.ToString()" CategoryProperty="Category" ValueProperty="TotalExpense">
            </RadzenPieSeries>
        </RadzenChart>
    </RadzenCard>
    <RadzenCard>
        <RadzenChart Visible="@(_selectedMonth is Month.AllMonths)">
            <RadzenBarSeries Data="@_allYearDataGroupedByMonth" CategoryProperty="Month" Title="@_selectedYear.ToString()" LineType="LineType.Dashed" ValueProperty="TotalExpense"/>
            <RadzenValueAxis Formatter="@Formatter.FormatAsEuro">
                <RadzenGridLines Visible="true"/>
                <RadzenAxisTitle Text="Total expenses"/>
            </RadzenValueAxis>
            <RadzenBarOptions Radius="5"/>
        </RadzenChart>
    </RadzenCard>
    <RadzenCard>
        <RadzenChart Visible="@(_selectedMonth is Month.AllMonths)">
            <RadzenPieSeries Data="@_allYearDataGroupedByCategory" Title="@_selectedYear.ToString()" CategoryProperty="Category" ValueProperty="TotalExpense">
            </RadzenPieSeries>
        </RadzenChart>
    </RadzenCard>
@*COLUMN*@
@*<RadzenChart>
        <RadzenColumnSeries Data="@_dataGroupedByMonth" CategoryProperty="Month" Title="@_date.Year.ToString()" LineType="LineType.Dashed" ValueProperty="TotalExpense" />
        <RadzenColumnOptions Radius="5" />
        <RadzenValueAxis Formatter="@Format">
            <RadzenGridLines Visible="true" />
            <RadzenAxisTitle Text="Total expense" />
        </RadzenValueAxis>
    </RadzenChart>*@
}
@code {
    private IEnumerable<Xpense.Expense> _expenses = Array.Empty<Xpense.Expense>();
    private IList<MonthDataItem> _allYearDataGroupedByMonth;
    private IList<CategoryDataItem> _allYearDataGroupedByCategory;
    private IList<CategoryDataItem> _selectedMonthDataGroupedByCategory;
    private IList<int> _availableYears;
    private IList<Month> _availableMonths;
    private int _selectedYear;
    private Month _selectedMonth;
    private double _averageExpensePerMonth;

    protected override async Task OnInitializedAsync()
    {
        _selectedYear = DateTimeOffset.Now.Year;
        _selectedMonth = (Month)DateTimeOffset.Now.Month;
        _averageExpensePerMonth = 0.0;
        InitializeAvailableYears();
        InitializeAvailableMonths();
        _allYearDataGroupedByMonth = new List<MonthDataItem>();
        _allYearDataGroupedByCategory = new List<CategoryDataItem>();
        _selectedMonthDataGroupedByCategory = new List<CategoryDataItem>();
        await GetExpensesAsync();
    }

    #region Utility Methods

    private void InitializeAvailableMonths()
    {
        _availableMonths = Enum.GetValues<Month>();
    }

    private void InitializeAvailableYears()
    {
        _availableYears = new List<int>();
        for (var year = 2021; year <= DateTimeOffset.Now.Year; year++)
        {
            _availableYears.Add(year);
        }
    }

    private async Task OnYearChange(object value)
    {
        _selectedYear = (int)value;
        await GetExpensesAsync();
    }

    private async Task OnMonthChange(object value)
    {
        _selectedMonth = (Month)value;
        await GetExpensesAsync();
    }

    private async Task GetExpensesAsync()
    {
        try
        {
            if (_selectedMonth is Month.AllMonths)
            {
                _expenses = (await ExpensesManager.GetAllAsync(null, null, _selectedYear.ToString()))
                    .OrderByDescending(e => e.ExpenseDetails.Date);

                var groupDataByMonth = GroupDataByMonth();
                var groupedDataByCategory = GroupDataByCategory();

                _allYearDataGroupedByMonth = FillDataForAllMonths(groupDataByMonth);
                _allYearDataGroupedByCategory = FillDataForAllCategories(groupedDataByCategory);
                _averageExpensePerMonth = GetAverageExpensesPerMonth(_allYearDataGroupedByMonth);
            }
            else
            {
                _expenses = (await ExpensesManager.GetAllAsync(null, null, $"{_selectedYear}-{(int)_selectedMonth:D2}"))
                    .OrderByDescending(e => e.ExpenseDetails.Date);

                var groupedDataByCategory = GroupDataByCategory();
                _selectedMonthDataGroupedByCategory = FillDataForAllCategories(groupedDataByCategory);
                _averageExpensePerMonth = _expenses.Select(d => d.ExpenseDetails.Value).Sum();
            }
        }
        catch (Exception e)
        {
            await DialogService.AlertAsync(AlertType.Error, "Error", $"Cannot retrieve expenses. Error: {e}");
        }
    }

    private static List<CategoryDataItem> FillDataForAllCategories(IReadOnlyCollection<CategoryDataItem> groupedData)
    {
        var finalData = new List<CategoryDataItem>();
        foreach (var category in Enum.GetNames(typeof(Category)))
        {
            var categoryData = groupedData.FirstOrDefault(d => d.Category == category);
            finalData.Add(categoryData ?? new CategoryDataItem
            {
                Category = category,
                TotalExpense = 0
            });
        }

        return finalData;
    }

    private static List<MonthDataItem> FillDataForAllMonths(IReadOnlyCollection<MonthDataItem> groupedData)
    {
        var finalData = new List<MonthDataItem>();
        for (var month = (int)Month.January; month <= (int)Month.December; month++)
        {
            var dataOfTheMonth = groupedData.FirstOrDefault(d => d.Month == month.ToString());
            finalData.Add(dataOfTheMonth ?? new MonthDataItem
                {
                    Month = month.ToString(),
                    TotalExpense = 0
                });
        }

        return finalData;
    }

    private double GetAverageExpensesPerMonth(IList<MonthDataItem> data)
    {
        var sumOfExpenses = 0.0;
        var finalMonth = (int)Month.December;
        var now = DateTimeOffset.Now;

        if (now.Year == _selectedYear)
        {
            finalMonth = now.Month;
        }

        for (var month = (int)Month.January; month <= finalMonth; month++)
        {
            sumOfExpenses += data[month - 1].TotalExpense;
        }

        var averageExpensesPerMonth = sumOfExpenses / finalMonth;

        return averageExpensesPerMonth;
    }

    private List<MonthDataItem> GroupDataByMonth()
    {
        return _expenses.Select(e => new MonthDataItem
            {
                Month = e.ExpenseDetails.Date.Month.ToString(),
                TotalExpense = e.ExpenseDetails.Value
            }).GroupBy(d => d.Month, d => d.TotalExpense, (month, totalExpenses) => new MonthDataItem
            {
                Month = month,
                TotalExpense = totalExpenses.Sum()
            }).ToList();
    }

    private List<CategoryDataItem> GroupDataByCategory()
    {
        return _expenses.Select(e => new CategoryDataItem
        {
            Category = e.ExpenseDetails.Category.ToString(),
            TotalExpense = e.ExpenseDetails.Value
            }).GroupBy(d => d.Category, d => d.TotalExpense, (category, totalExpenses) => new CategoryDataItem
        {
            Category = category,
            TotalExpense = totalExpenses.Sum()
        }).ToList();
    }

    #endregion

    #region Utility Classes

    private enum Month
    {
        AllMonths = 0,
        January = 1,
        February = 2,
        March = 3,
        April = 4, 	
        May = 5, 	
        June = 6, 	
        July = 7, 	
        August = 8, 	
        September = 9,
        October = 10,
        November = 11,
        December = 12
    }

    private record MonthDataItem
    {
        public string Month { get; set; }
        public double TotalExpense { get; set; }
    }

    private record CategoryDataItem
    {
        public string Category { get; set; }
        public double TotalExpense { get; set; }
    }

    #endregion
}
