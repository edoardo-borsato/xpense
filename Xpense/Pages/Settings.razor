@page "/settings"
@inject IDialogService DialogService
@inject ISettingsManager SettingsManager

@if (_settingsData == null)
{
    <Loading />
}
else
{
    <RadzenCard>
        <EditForm Model="_settingsData" OnSubmit="@Submit">
            <RadzenRow Gap="1rem">
                <RadzenColumn>
                    <RadzenRow Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H6"><strong>Username</strong></RadzenText>
                    </RadzenRow>
                    <RadzenRow Gap="1rem">
                        <RadzenTextBox @bind-Value="@_settingsData.Username" Class="w-100" />
                    </RadzenRow>
                </RadzenColumn>
            </RadzenRow>
            <br />
            <RadzenRow Gap="1rem" class="rz-text-align-right">
                <RadzenColumn>
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Text="Save"></RadzenButton>
                </RadzenColumn>
            </RadzenRow>
        </EditForm>
    </RadzenCard>
}

@code {

    private readonly ExpensesServiceSettings _settingsData = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settingsData.Username = SettingsManager.GetUsername();
            _settingsData.Url = SettingsManager.GetExpensesServiceUri().AbsoluteUri;
        }
        catch (Exception e)
        {
            await DialogService.AlertAsync(AlertType.Error, "Error", $"Unable to retrieve settings. Error: {e}");
        }
    }

    private async Task Submit()
    {
        var confirmed = await DialogService.ConfirmAsync("Save settings", "Are you sure you want to save settings?");
        if (confirmed)
        {
            try
            {
                SettingsManager.SetUsername(_settingsData.Username);
                await DialogService.AlertAsync(AlertType.Success, "Save settings", "Settings saved");
            }
            catch (Exception e)
            {
                await DialogService.AlertAsync(AlertType.Error, "Error", $"Unable to save settings. Error: {e}");
            }
        }
    }

    private record ExpensesServiceSettings
    {
        public string Username { get; set; }
        public string Url { get; set; }
    }
}
